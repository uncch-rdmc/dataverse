pipeline {
  agent any

  stages {

    stage('Build') {
      when {
	changeset "doc/sphinx-guides/**"
      }
      steps {
	cd ${WORKSPACE}/doc/sphinx-guides/
	make clean
	make html
	make epub
      }
    }

    stage('Test') {
      when {
	changeset "doc/sphinx-guides/**"
      }
      steps {
	cd ${WORKSPACE}/doc/sphinx-guides/
	make doctest
      }
    }

    stage('Post') {
      when {
	changeset "doc/sphinx-guides/**"
      }
      steps {
	cd ${WORKSPACE}/doc/sphinx-guides/
	cp build/epub/Dataverse.epub build/html
	zip -r ${WORKSPACE}/${CHANGE_BRANCH}.zip ./
      }
    }
  }
}

pipeline {
  agent any

  stages {

    stage('Build') {
      when {
	{ expression { return sourceChanged(doc/shinx-guides/) } }
      }
      steps {
	sh 'cd ${WORKSPACE}/doc/sphinx-guides/'
	sh 'make clean'
	sh 'make html'
	sh 'make epub'
      }
    }

    stage('Test') {
      when {
	{ expression { return sourceChanged(doc/shinx-guides/) } }
      }
      steps {
	sh 'cd ${WORKSPACE}/doc/sphinx-guides/'
	sh 'make doctest'
      }
    }

    stage('Post') {
      when {
	{ expression { return sourceChanged(doc/shinx-guides/) } }
      }
      steps {
	sh 'cd ${WORKSPACE}/doc/sphinx-guides/'
	sh 'cp build/epub/Dataverse.epub build/html'
	sh 'zip -r ${WORKSPACE}/${CHANGE_BRANCH}.zip ./'
      }
    }
  }
}
